= Pkl 0.28 Release Notes
:version: 0.28
:version-minor: 0.28.0
:release-date: February 26th, 2025

include::ROOT:partial$component-attributes.adoc[]

:uri-snippet-tests: {uri-github-tree}/pkl-core/src/test/files/LanguageSnippetTests/input
:uri-standard-library: {uri-github-tree}/stdlib/
:uri-antlr: https://www.antlr.org

Pkl {version} was released on {release-date}. +
[.small]#The latest bugfix release is {version-minor}. (xref:changelog.adoc[All Versions])#

The next release (0.29) is scheduled for June 2025.
To see what's coming in the future, follow the https://github.com/orgs/apple/projects/12/views/1[Pkl Roadmap].

Please send feedback and questions to https://github.com/apple/pkl/discussions[GitHub Discussions], or submit an issue on https://github.com/apple/pkl/issues/new[GitHub]. +

[small]#Pkl is hosted on https://github.com/apple/pkl[GitHub].
To get started, follow xref:pkl-cli:index.adoc#installation[Installation].#

== Highlights [small]#üíñ#

News you don't want to miss.

=== New parser

Pkl has new parser (https://github.com/apple/pkl/pull/917[#917], https://github.com/apple/pkl/pull/957[#957], https://github.com/apple/pkl/pull/962[#962])!

The first step to evaluating a program is to parse its source code into a parse tree.
Currently, Pkl uses link:{uri-antlr}[ANTLR] to generate parser code from grammar files.

Using this approach has allowed for rapidly iterating and changing the language's grammar.
However, Pkl's grammar has matured; it's not as likely that the grammar will change from one version to the next.
Additionally, the current parser's performance has become more painful as projects written in Pkl grow in size.
In many cases, parsing can take up most of the time spent during evaluation.

In 0.28, ANTLR is being replaced by a handwritten parser.
This improves parsing speed by around two orders of magnitude.
Here are some quick comparisons between the two parsers, run on a MacBook Pro M4 Max machine, with 5 warmup iterations, and run for 10 iterations:

|===
||Old parser |New parser

|link:{uri-snippet-tests}[Language snippet tests]
|440.8ms
|5.9ms

|link:{uri-standard-library}[Standard library]
|136.7msfootnote:[In the `pkl` CLI, the standard library is parsed during compilation rather than during evaluation. As a result, there is no parsing overhead.]
|0.8ms

|All https://github.com/apple/pkl-pantry[pkl-pantry] modules
|1424.2ms
|7.0ms
|===

== Noteworthy [small]#üé∂#

Ready when you need them.

=== CLI improvements

==== Colored help messages

The `pkl`, `pkldoc`, `pkl-codegen-java`, and `pkl-codegen-kotlin` CLIs now emits help text with colors (https://github.com/apple/pkl/pull/947[#947]).

Here is a sneak peek:

image::pkl-cli-help-new.png[new pkl cli help output]

Thanks to https://github.com/gordonbondon[@gordonbondon] for their contribution!

==== `jpkl` support on Windows

The `jpkl` executable is now supported on Windows (https://github.com/apple/pkl/pull/872[#872]).

`jpkl` is a fat jar that can be executed directly when on macOS and Linux, but current users of Windows are required to execute it with `java -jar jpkl`.

In 0.28, Windows users can also call execute this command directly.
To do so, the filename should be called `jpkl.bat`, and placed in `PATH`.

=== Type constraint changes

Type annotations that are executed as a result of calling a constraint expressions now perform an eager typecheck (https://github.com/apple/pkl/pull/964[#964]).

In Pkl 0.27, we changed how xref:0.27.adoc#typecheck-improvements[typechecks are executed for `Listing` and `Mapping`] types.

However, this had two unintended side effects:

For one, error messages from certain failing constraints show `?` in place of values that are failing.

The following snippet:

[source%parsed,pkl]
----
class Bird { name: String }

bird: Listing<Bird>(firstOneIsQuail) = new {
  new { name = "Pigeon" }
  new { name = "Quail" }
}

local firstOneIsQuail = (it: Listing<Bird>) -> it[0].name == "Quail"
----

Produces the following error message:

[source]
----
‚Äì‚Äì Pkl Error ‚Äì‚Äì
Type constraint `firstOneIsQuail` violated.
Value: new Listing { ?; ? }

3 | bird: Listing<Bird>(firstOneIsQuail) = new {
                        ^^^^^^^^^^^^^^^
----

:fn-typecheck-details: footnote:[See https://github.com/apple/pkl-evolution/blob/main/spices/SPICE-0010-overhauled-mapping-listing-typechecks.adoc#delegating-objects[delegating objects] in SPICE-0010 for more details on this behavior.]

This is happening because lazy typechecks of mappings and listings will return a _new_ listing. Because the lambda's argument is defined as ``it: Listing<Bird>``, the value being passed into the function body is this new listing{fn-typecheck-details}.

Secondly, some constraints became less strict, allowing more values to pass.

The following snippet fails in Pkl 0.26, but passes in Pkl 0.27:

[source%parsed,pkl]
----
class Bird { name: String }

birds: Listing(nonEmpty) = new { 1; 2; 3 }

local nonEmpty = (it: Listing<Bird>) -> !it.isEmpty
----

To address both of these issues, the rule for executing type constraints has changed.
When executing a type annotation, mapping and listing typechecks are always _eager_.
This means that Pkl will check that each member of the mapping/listing conforms to the type parameter.

=== Java 22+ support

Pkl's Java libraries now support Java 22 and higher (https://github.com/apple/pkl/pull/876[#876]).

Thanks to https://github.com/sgammon[@sgammon] for their contribution!

=== New standard library method

The `pkl:math` standard library module has a new method, called {uri-stdlib-mathModule}/index.html#atan2()[atan2] (https://github.com/apple/pkl/pull/819[#819]).
It computes the https://en.wikipedia.org/wiki/Atan2[2-argument arctangent].

Thanks to https://github.com/gordonbondon[@gordonbondon] for their contribution!

=== Overhauled for-generator implementation

The implementation of xref:language-reference:index.adoc#for-generators[for-generators] has been overhauled (https://github.com/apple/pkl/pull/844[#844]).

This fixes some known bugs with the current for-generator implementation, and also improves code health by reducing complexity and removing workarounds and band-aids.

Thanks to https://github.com/odenix[@odenix] for their contribution!

=== Java code generator improvements

Improvements have been made to the code generators (https://github.com/apple/pkl/pull/792[#792]).

The `--params-annoatation` flag now accepts `none` as a value, which causes the code generator to skip adding annotations to a constructor's parameters.

Additionally, these annotations will not be added if the `--generate-spring-boot-config` flag is set.

This is useful for those compiling Java code with the `-parameters` flag set, because the pkl-config-java library is able to map into these classes without any extra annotations.

Thanks to https://github.com/odenix[@odenix] for their contribution!

=== pkldoc improvements

pkldoc has a new flag to write real files instead of symlinks (https://github.com/apple/pkl/pull/824[#824]).

Currently, pkldoc creates a symlink called "current", which points to the latest non-prerelease version of a package.
However, these symlinks can be problematic for some systems.

A new flag, `--no-symlinks`, and a similarly named Gradle property, `noSymlinks`, instructs pkldoc to write real files instead of symlinks. 

Thanks to https://github.com/netvl[@netvl] for their contributions!

=== `jar:nested:` URIs are accepted by default

To improve integration with Spring Boot, the Pkl evaluator by default now accepts module URIs starting with `jar:nested:` (https://github.com/apple/pkl/pull/895[#895]).

The `--allowed-modules` flag (and the equally named option in other APIs) can be used to configure the set of allowed modules.

== Breaking Changes [small]#üíî#

Things to watch out for when upgrading.

=== Stricter grammar

As a result of implementing a new parser, the following previously accepted grammar is no longer valid (https://github.com/apple/pkl/pull/917[#917]).

==== Inline object entries require a semicolon

An xref:language-tutorial:01_basic_config.adoc#entries[_entry_] is one of the three types of object members that can inhabit an object. 

When declaring multiple entries on the same line, a semicolon is now required to separate them.

The following code snippet is currently valid, and becomes a syntax error in 0.28.

[source,pkl]
----
obj { ["one"] = 1 ["two"] = 2 }
----

To fix, insert a semicolon between the two entries:

[source,diff]
----
-obj { ["one"] = 1 ["two"] = 2 }
+obj { ["one"] = 1; ["two"] = 2 }
----

==== String escapes require correct number of pounds

When using xref:language-reference:index.adoc#custom-string-delimiters[custom string delimiters], the escape sequence becomes backslash (`\`) plus the number of pounds used to delimit the string.

Due to a parser bug, any extra pound signs past the required amount are permitted.

In Pkl 0.28, this becomes a syntax error.

[source,pkl]
----
foo = "foo \####(bar)"
----

==== Whitespace required between inline generator members

Inline object spreads, for generators, and when generators all now require either whitespace or a semicolon separator.

[source,pkl]
----
foo { ...bar...baz } // Syntax error
----

=== Minimum Gradle version bump

The minimum Gradle version for the xref:main:pkl-gradle:index.adoc[Gradle Plugin] has been bumped to 8.2 (https://github.com/apple/pkl/pull/901[#901]).

=== Java/Kotlin API breaking changes

Breaking changes have been made to the Java/Kotlin APIs (https://github.com/apple/pkl/pull/748[#748], https://github.com/apple/pkl/pull/749[#749], https://github.com/apple/pkl/pull/776[#776], https://github.com/apple/pkl/pull/808[#808], https://github.com/apple/pkl/pull/810[#810]).

* `org.pkl.core.resource.Resource` +
  Converted into a `record`; previous getter methods are deprecated.

* `org.pkl.core.project.Package` +
  Converted into a `record`; previous getter methods are deprecated.

* `org.pkl.core.Member.SourceLocation` +
  Converted into a `record`; previous getter methods are deprecated.

* `org.pkl.core.Release` +
  Converted into a `record`; previous getter methods are deprecated.

* `org.pkl.core.Release.SourceCode` +
  Converted into a `record`; previous getter methods are deprecated.

* `org.pkl.core.Release.Documentation` +
  Converted into a `record`; previous getter methods are deprecated.

* `org.pkl.core.Release.StandardLibrary` +
  Converted into a `record`; previous getter methods are deprecated.

* `org.pkl.core.project.DeclaredDependencies` +
  Converted into a `record`; previous getter methods are deprecated.

* `org.pkl.codegen.kotlin.CliKotlinCodeGeneratorOptions.toKotlinCodegenOptions` +
  Deprecated without replacement

* `org.pkl.core.evaluatorSettings.PklEvaluatorSettings.Proxy.create` +
  Deprecated; use the constructor instead.

* `org.pkl.core.module.ExternalModuleResolver` +
  Moved into package `org.pkl.core.externalreader`

* `org.pkl.core.resource.ExternalResourceResolver` +
  Moved into package `org.pkl.core.resource`

* `org.pkl.core.messaging.MessageTransportModuleResolver` +
  Renamed to `ExternalModuleResolverImpl`, made package-private

* `org.pkl.core.messaging.MessageTransportResourceResolver` +
  Renamed to `ExternalResourceResolverImpl`, made package-private

* `org.pkl.core.module.ExternalModuleResolver.Spec` +
  Replaced with record `org.pkl.core.externalreader.ModuleReaderSpec`

* `org.pkl.core.resource.ExternalResourceResolver.Spec` +
  Replaced with record `org.pkl.core.externalreader.ResourceReaderSpec`

* `org.pkl.core.messaging.CreateEvaluatorRequest` +
  Changed properties `allowedModules` and `allowedResources` to be of type `List<String>` instead of `List<Pattern>`


=== Fat jars no longer shade Truffle

Pkl publishes two fat jars to Maven Central: https://central.sonatype.com/artifact/org.pkl-lang/pkl-tools[pkl-tools], and https://central.sonatype.com/artifact/org.pkl-lang/pkl-config-java-all[pkl-config-java-all].

Due a version bump in the Truffle library, the package `com.oracle.truffle` can no longer be shaded.

For users that use both Pkl and other Truffle languages, this means that their version of Truffle should match Pkl's version.

== Miscellaneous [small]#üê∏#

* Pkl's version of Kotlin has been upgraded to 2.0 (https://github.com/apple/pkl/pull/900[#900]).
* The repository now requires Java 21 or higher to build (https://github.com/apple/pkl/pull/876[#876]).
* Documentation improvements (https://github.com/apple/pkl/pull/792[#792], https://github.com/apple/pkl/pull/846[#846], https://github.com/apple/pkl/pull/860[#860], https://github.com/apple/pkl/pull/892[#892], https://github.com/apple/pkl/pull/921[#921], https://github.com/apple/pkl/pull/937[#937], https://github.com/apple/pkl/pull/943[#943], https://github.com/apple/pkl/pull/944[#944], https://github.com/apple/pkl/pull/955[#955], https://github.com/apple/pkl/pull/956[#956], https://github.com/apple/pkl/pull/973[#973])
* Allow setting commit id via `-DcommitId` flag when building Pkl (https://github.com/apple/pkl/pull/954[#954])
* Enable multi-jdk testing via `-DmultiJdkTesting=true` flag when building Pkl (https://github.com/apple/pkl/pull/876[#876])

== Bugs fixed [small]#üêú#

The following bugs have been fixed.

[smaller]
* Optimization: `const` members should be cached for all children in the prototype chain (https://github.com/apple/pkl/issues/508[#508])
* Late-bound values of iteratees within nested for/spread fail to resolve for-generator variables (https://github.com/apple/pkl/issues/741[#741])
* codegen-java/kotlin: Fix generation of equals/hashCode methods (https://github.com/apple/pkl/pull/802[#802]) 
* Not possible to render mapping with Int keys in YAML (https://github.com/apple/pkl/issues/878[#878])
* Parser accepts wrong string escapes (https://github.com/apple/pkl/issues/888[#888])
* Downstream native-image embedders are broken (https://github.com/apple/pkl/issues/907[#907])
* Failed type constraint error messages do not show forced members (https://github.com/apple/pkl/issues/918[#918])
* Spread elements inside an object body don't need separators (https://github.com/apple/pkl/issues/932[#932])
* Bad import analysis fails with "None (cause has no message)" (https://github.com/apple/pkl/issues/949[#949])
* Correctly set allowed modules/resoures when external reader scheme contain regex control characters (https://github.com/apple/pkl/pull/937[#937])
* Parser accepts wrong string escapes (https://github.com/apple/pkl/issues/888[#888])
* ANTLR incompatibilities (https://github.com/apple/pkl/issues/927[#927])
* Doc comments with interleaving comments result in an error (https://github.com/apple/pkl/issues/931[#931])

== Contributors [small]#üôè#

We would like to thank the contributors to this release (in alphabetical order):

* https://github.com/gordonbondon[@gordonbondon]
* https://github.com/HT154[@HT154]
* https://github.com/jsoref[@jsoref]
* https://github.com/KushalP[@KushalP]
* https://github.com/netvl[@netvl]
* https://github.com/odenix[@odenix]
* https://github.com/romacafe[@romacafe]
* https://github.com/sgammon[@sgammon]
* https://github.com/sorcix[@sorcix]
* https://github.com/stanleyycheung[@stanleyycheung]
